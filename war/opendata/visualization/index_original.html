<meta charset="utf-8">
<!-- START SIGMA IMPORTS -->
<script src="src/sigma.core.js"></script>
<script src="src/conrad.js"></script>
<script src="src/utils/sigma.utils.js"></script>
<script src="src/utils/sigma.polyfills.js"></script>
<script src="src/sigma.settings.js"></script>
<script src="src/classes/sigma.classes.dispatcher.js"></script>
<script src="src/classes/sigma.classes.configurable.js"></script>
<script src="src/classes/sigma.classes.graph.js"></script>
<script src="src/classes/sigma.classes.camera.js"></script>
<script src="src/classes/sigma.classes.quad.js"></script>
<script src="src/classes/sigma.classes.edgequad.js"></script>
<script src="src/captors/sigma.captors.mouse.js"></script>
<script src="src/captors/sigma.captors.touch.js"></script>
<script src="src/renderers/sigma.renderers.canvas.js"></script>
<script src="src/renderers/sigma.renderers.webgl.js"></script>
<script src="src/renderers/sigma.renderers.svg.js"></script>
<!--<script src="src/renderers/sigma.renderers.def.js"></script>
<script src="src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
<script src="src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
<script src="src/renderers/webgl/sigma.webgl.edges.def.js"></script>
<script src="src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
<script src="src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>-->
<script src="src/renderers/canvas/sigma.canvas.labels.def.js"></script>
<script src="src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
<script src="src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
<script src="src/renderers/canvas/sigma.canvas.edges.def.js"></script>
<!--<script src="src/renderers/canvas/sigma.canvas.edges.curve.js"></script>-->
<script src="src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
<!--<script src="src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
<script src="src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
<script src="src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
<script src="src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
<script src="src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
<script src="src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
<script src="src/renderers/svg/sigma.svg.utils.js"></script>
<script src="src/renderers/svg/sigma.svg.nodes.def.js"></script>
<script src="src/renderers/svg/sigma.svg.edges.def.js"></script>
<script src="src/renderers/svg/sigma.svg.edges.curve.js"></script>-->
<script src="src/renderers/svg/sigma.svg.labels.def.js"></script>
<!--<script src="src/renderers/svg/sigma.svg.hovers.def.js"></script>-->
<script src="src/middlewares/sigma.middlewares.rescale.js"></script>
<script src="src/middlewares/sigma.middlewares.copy.js"></script>
<script src="src/misc/sigma.misc.animation.js"></script>
<script src="src/misc/sigma.misc.bindEvents.js"></script>
<!--<script src="src/misc/sigma.misc.bindDOMEvents.js"></script>-->
<script src="src/misc/sigma.misc.drawHovers.js"></script>
<!-- END SIGMA IMPORTS -->
<script src="plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
<script src="plugins/sigma.plugins.animate/sigma.plugins.animate.js"></script>
<script src="plugins/sigma.renderers.customShapes/shape-library.js"></script>
<script src="plugins/sigma.renderers.customShapes/sigma.renderers.customShapes.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<style>
	.container {
		width: 100%;
		height: 100%;
		position: relative;
		background-image: url("img/background.jpg");
		background-repeat: repeat-x;
	}
	#question {
		display: table;
		margin: 0 auto;
	}

	#graph-container {
		height: calc(95vh - 50px);
	}

	#solrInfo {
		height: calc(65vh - 50px - 70px);
		overflow-y: auto;
	}
	#info {
		height: calc(35vh - 50px - 70px);
		overflow-y: auto;
	}

	#quepyInfo {
		height: calc(70vh - 50px);
		margin-bottom: 3vh;
		overflow-y: auto;
	}
	#alertMaximumNodes {
		height: calc(15vh - 50px);
		overflow-y: none;
	}
	#nodesSlider {
		height: calc(12vh - 50px);
		overflow-y: hidden;
	}
</style>

<div class="container">
	<div class="row">
		<div class="col-sm-6" style="display:flex;align-items:center;height:50px;">
			<input type="text" id="question" class="form-control" placeholder="Realice una pregunta...">
		</div>
		<div class="col-sm-6">
			<img src="img/logo.gif" align="right">
		</div>
	</div>
	<div class="row">
		<div class="col-sm-2">
			<h1>Panel <small>Respuestas</small></h1>
			<div id="quepyInfo">
			</div>
			<div id="alertMaximumNodes"></div>
			<div id="nodesSlider">
				<p>Nodos mostrados: <strong><span id="spanNodes"></span></strong></p>
				<input id="rangeNodes" type="range" min="10" max="100" value="20"/>
			</div>
		</div>
		<div id="graph-container" class="col-sm-7"></div>
		<div class="col-sm-3">
			<h1>Panel <small>Texto</small></h1>
			<div id="solrInfo"></div>
			<h1>Panel <small>Conceptos</small></h1>
			<div id="info"></div>
		</div>
	</div>
</div>
<script>

// Update slide value
var slider = document.getElementById("rangeNodes");
var output = document.getElementById("spanNodes");
output.innerHTML = slider.value;

slider.oninput = function() {
  output.innerHTML = this.value;
}

// Submit al pulsar enter en la caja de texto
$('#question').keypress(function(e){
  if(e.keyCode==13)
		quepyRequest(document.getElementById('question').value);
});

// INICIALIZACIÓN DE VARIABLES
var s = new sigma({
  settings: {
	autoRescale: false,
	minArrowSize: 20,
	animationsTime: 1000,
	defaultNodeColor: "#EEE",
	defaultEdgeType: "arrow"
  },
  renderer: {
	container: document.getElementById('graph-container'),
	type: 'canvas'
  }
});

// Activa las formas personalizadas, usada para poner iconos en los nodos
CustomShapes.init(s);

// Para poder mover los nodos
var dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);

// Al hacer click llamar a <changeGraph>
dragListener.bind('drag', function(e) {
  dragListener.unbind('dragend');
});

dragListener.bind('startdrag', function(event) {
	if(event["data"]["node"]["fin_x"] != 0 || event["data"]["node"]["fin_y"] != 0){  // Si no es el nodo central
		dragListener.bind('dragend', function(e) {
			changeGraph(e["data"]["node"]["nodeName"],e["data"]["node"]["read_cam0:x"],e["data"]["node"]["read_cam0:y"]);
		});
		setTimeout(function(){dragListener.unbind('dragend');}, 500);
	}
});

// Para expandir la etiqueta al pasar el ratón por encima
s.bind('overNode', function(e) {
  e.data.node["label"] = e.data.node['over_label'];
  s.refresh();
});

s.bind('outNode', function(e) {
  e.data.node["label"] = e.data.node['ini_label'];
  s.refresh();
});

var timeout = 0; // Tiempo entre animaciones (inicial 0 segundos)

// Función para comprobar si un string es una URL
function isURL(str) {
  var pattern = new RegExp('^https?://.+');
  return pattern.test(str) && !str.includes("ei2a/categorization");
}

/*
	Fill <panel> with <header> as top message and <list> as information,
	if <printKey> prints the keys of <list>
*/
function printPanel(panel, header, list, printKey){
	aux = "<div class='list-group'>"
	if(header != null) aux = "<div class='list-group-item active'>" + header + "</div>";
	for (key in list){
		if (list[key] instanceof Array){
			aux += "<div class='list-group-item'><strong>" + key + "</strong><div class='list-group'>";
			for(key2 in list[key]){
				aux += "<div class='list-group-item'>" + list[key][key2] + "</div>";
			}
			aux += "</div></div>";
			$(panel).append(aux);
		} else {
			aux += "<div class='list-group-item'>";
			if(printKey) aux += "<strong>" + key + "</strong><br/>";
			if (isURL(list[key])){
				url = list[key];
				if(url.length > 55){
					display = url.substr(0,52) + "...";
				}else{
					display = url;
				}
				aux += display.link(url);
			}else{
				aux += list[key];
			}
			aux += "</div>";
		}
	}
	aux += "</div>";
	$(panel).html(aux);
}

// Displays one answer
function printPanelOneAnswer(json, key){
	list = json["results"][key];
	aux = "<div class='list-group'><div class='list-group-item active'>" + json["message"].replace("{0}",key) + "</div>";
	for (key in list){
			aux += "<div class='list-group-item btn btn-default hiddenAnswer' style='white-space: normal;text-align: left;' node='" + list[key][1] + "'>";
			if (isURL(list[key][0])){
				url = list[key][0];
				if(url.length > 33){
					display = url.substr(0,30) + "...";
				}else{
					display = url;
				}
				aux += display;
			}else{
				aux += list[key][0];
			}
			aux += "</div>";
	}
	aux += "</div>";
	$('#quepyInfo').html(aux);

	$('.hiddenAnswer').click(function(event){
		changeGraph(event.target.attributes.node.value,0,0);
	});
}

// Displays multiple answers keys and makes it buttons
function printPanelMultipleAnswer(json){
	aux = "<div class='list-group'><div class='list-group-item active'>Múltiples respuestas encontradas:</div>";
	for (key in json["results"]){
		aux += "<div class='list-group-item oneAnswer btn btn-default' style='white-space: normal;text-align: left;'>";
		aux += key;
		aux += "</div>";
		$('#quepyInfo').append(aux);
	}
	aux += "</div>";
	$('#quepyInfo').html(aux);
	$('.oneAnswer').click(function(event){
		key = event.target.textContent;
		printPanelOneAnswer(json, key);
	});
}

// Conexión con el servidor quepy
function quepyRequest(question, header) {
	//$.getJSON("http://127.0.0.1:5001/quepy?question=" + encodeURIComponent(question), function(json){
	//$.getJSON("http://193.146.117.225:8080/web-server/rest/executeWorkFlowGet/5ab39213b8b29400080c0503?wait=true&question=" + encodeURIComponent(question), function(json){
	$.getJSON("http://193.146.117.220:8880/web-server/rest/executeWorkFlowGet/5afbf8699194be00015eb2ee?save=false&wait=true&question=" + encodeURIComponent(question), function(json){
		//json = JSON.parse(json["results"]["content"]); // Parse results from Moriarty
		json = json["results"]["content"]; // Parse results from Moriarty
		if(!json["answer"]){ // No answer
			printPanel('#quepyInfo', json["message"], json["results"], false);
		} else if(Object.keys(json["results"]).length == 1){ // Only one answer
			key = Object.keys(json["results"])[0]; // Get the key of the only element
			printPanelOneAnswer(json, key);
		} else { // Multiples answers
			printPanelMultipleAnswer(json);
		}
	});
}

/*	Función principal, cambia el grafo dependiendo de <concept>
	<xAnimation> y <yAnimation> se usan para las animaciones
*/
function changeGraph(concept,xAnimation,yAnimation) {
	$('#info').html("<div class='panel panel-default'><div class='panel-body'><strong>Cargando datos...</strong></div></div>");
	$('#solrInfo').html("");
	$('#alertMaximumNodes').html("");
	s.graph.nodes().forEach(function(node){
		node["collapse_x"] = xAnimation;
		node["collapse_y"] = yAnimation;
	});

	sigma.plugins.animate(
		s,
		{x: 'collapse_x',y: 'collapse_y'}
	);

	var before = Date.now();

	// Petición para obtener el JSON
	//$.getJSON("http://127.0.0.1:5000/entity?concept=" + encodeURIComponent(concept) + "&nodes=" + encodeURIComponent(slider.value), function(json){
	$.getJSON("http://193.146.117.220:8880/web-server/rest/executeWorkFlowGet/5afe7a599194be0001f5b21c?save=false&wait=true&concept=" + encodeURIComponent(concept) + "&nodes=" + encodeURIComponent(slider.value), function(json){
		//json = JSON.parse(json["results"]["content"]); // Parse results from Moriarty
		json = json["results"]["content"]; // Parse results from Moriarty

		timeout = timeout - (Date.now() - before);
		timeout = timeout > 0 ? timeout : 0;

		// Posiciones iniciales
		json["graph"]["nodes"].forEach(function(node){
			node["x"] = xAnimation;
			node["y"] = yAnimation;
		});

		// Valores por defecto de los nodos !TODO averiguar como moverlos al constructor
		json["graph"]["nodes"].forEach(function(node){
			node["over_label"] = node["label"];
			if(node["label"].length > 33){
				node["label"] = node["label"].substr(0,30) + "...";
			}
			node["ini_label"] = node["label"];
			node["size"] = 20;
			node["borderColor"] = "#000";
			node["type"] = "circle";
		});

		// Esperar a que termine la animación de collapse
		setTimeout(function(){

			if (json["info"] != null){ // Rellenar info formateada
				printPanel('#info', null, json["info"], true);
			} else {
				$('#info').html("<div class='panel panel-default'><div class='panel-body'><strong>No hay información que mostrar</strong></div></div>");
			}

			// Rellenar info de solr
			if(json["solrInfo"] != null){
				printPanel('#solrInfo', null, json["solrInfo"], true);
			} else {
				$('#solrInfo').html("");
			}

			// Alerta de máximo de nodos alcanzados
			if(json["alertMaximumNodes"]){
				$("#alertMaximumNodes").html("<div class='alert alert-danger'><strong>Atención:</strong> Mostrando el máximo número de nodos</div>");
			}

			// Reiniciar el grafo y volverlo a llenar
			s.graph.clear();
			s.refresh();

			json["graph"]["nodes"].forEach(function(node){
				s.graph.addNode(node);
			});

			json["graph"]["edges"].forEach(function(edge){
				s.graph.addEdge(edge);
			});

			sigma.plugins.animate(
				s,
				{x: 'fin_x',y: 'fin_y'}
			);

			timeout = 1000;
		},timeout);

	});
}

//changeGraph("http://opendata.aragon.es/def/ei2a#Entidad2241",0,0);
//changeGraph("http://opendata.aragon.es/def/ei2a#ORG11198",0,0);
changeGraph("http://opendata.aragon.es/def/ei2a#Entidad420",0,0);
//changeGraph("http://opendata.aragon.es/def/ei2a#WebPage22",0,0);

</script>
